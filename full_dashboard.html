<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {margin:0;font-family:Arial;background:#1b1b1b;color:#f5f5f5;}
header {padding:15px;text-align:center;font-size:24px;font-weight:bold;}
#dashboard{padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.logout-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#f1c40f;}
.cards{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
.card{flex:1 1 200px;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;}
#map{height:300px;border-radius:12px;margin-bottom:20px;}
#sellerSettings{background:#fff;color:#000;padding:15px;border-radius:10px;margin-bottom:20px;}
.hidden{display:none;}
.alertSound{display:none;}
</style>
</head>
<body>

<header id="header">ColdGuard Dashboard</header>
<button class="logout-btn" onclick="logout()">ðŸšª Logout</button>

<div id="dashboard">

  <p><b>Role:</b> <span id="roleLabel"></span></p>

  <!-- Seller Only Settings -->
  <div id="sellerSettings" class="hidden">
    <h3>Temperature Alert Settings</h3>
    <input type="number" id="minTemp" placeholder="Min Â°C">
    <input type="number" id="maxTemp" placeholder="Max Â°C">
    <button onclick="saveTempSettings()">Save</button>
  </div>

  <div class="cards">
    <div class="card" id="tempCard">Temperature: -- Â°C</div>
    <div class="card" id="humCard">Humidity: -- %</div>
    <div class="card" id="statusCard">Status: --</div>
  </div>

  <div id="map"></div>

</div>

<audio id="alertAudio" src="https://actions.google.com/sounds/v1/cartoon/minion_laugh.ogg" class="alertSound"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// âœ… Check login
const role = localStorage.getItem('role');
if(!role){
  window.location.href = 'login.html';
}
document.getElementById('roleLabel').innerText = role;

// Theme colors
const roleColors = {Seller:'#f39c12', Buyer:'#2ecc71', Driver:'#3498db'};
document.getElementById('header').style.backgroundColor = roleColors[role];

// Seller settings
if(role==='Seller'){
  document.getElementById('sellerSettings').classList.remove('hidden');
}

// Logout
function logout(){
  localStorage.removeItem('role');
  window.location.href='login.html';
}

// Temperature alert
let alertMin = null;
let alertMax = null;

function saveTempSettings(){
  alertMin = Number(document.getElementById('minTemp').value);
  alertMax = Number(document.getElementById('maxTemp').value);
  alert('Saved!');
}

// Map
const map = L.map('map').setView([13.736717,100.523186],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;

// Load latest records
const recordsRef = ref(db,'records/latest');
onValue(recordsRef,snap=>{
  const data = snap.val();
  if(!data) return;
  const temp = data.temperature;
  const hum = data.humidity;
  const status = data.status || 'OK';
  document.getElementById('tempCard').textContent = `Temperature: ${temp} Â°C`;
  document.getElementById('humCard').textContent = `Humidity: ${hum} %`;
  document.getElementById('statusCard').textContent = `Status: ${status}`;

  // Color temp card based on alert
  if(role==='Seller' && alertMin!==null && alertMax!==null && (temp<alertMin || temp>alertMax)){
    document.getElementById('tempCard').style.backgroundColor = '#e74c3c';
    document.getElementById('alertAudio').play();
  } else {
    document.getElementById('tempCard').style.backgroundColor = roleColors[role];
  }

  // Update map
  if(data.gps){
    const lat = data.gps.lat;
    const lng = data.gps.lng;
    if(!marker) marker = L.marker([lat,lng]).addTo(map);
    else marker.setLatLng([lat,lng]);
    map.setView([lat,lng]);
  }
});
</script>

</body>
</html>
