<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {margin:0;font-family:Arial,sans-serif;background:#eef2f7;color:#333;}
header {color:white;padding:20px;font-size:22px;text-align:center;}
.container {padding:20px;max-width:1200px;margin:auto;}
.cards {display:flex;gap:20px;margin-bottom:20px;}
.card {flex:1;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center;color:white;transition:0.3s;}
.card h3 {margin-bottom:10px;color:white;}
.card .value {font-size:32px;font-weight:bold;}
#map {height:300px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table {width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;margin-bottom:20px;}
th, td {padding:10px;border-bottom:1px solid #eee;text-align:center;}
th {background:#f1f2f6;}
#settings {background:white;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;display:none;}
button {padding:8px 16px;margin:0 5px;border:none;border-radius:5px;cursor:pointer;}
button:disabled {background:#aaa;}

/* ðŸ”¹ Blink Animation */
@keyframes blink {
  0%, 50%, 100% {opacity: 1;}
  25%, 75% {opacity: 0.3;}
}
.blink {animation: blink 1s infinite;}
</style>
</head>
<body>

<header id="header">ColdGuard Dashboard (<span id="roleLabel"></span>)</header>

<div class="container">

<div id="settings">
<h3>Temperature Alert Setting (Seller Only)</h3>
<label>Min Temp (Â°C): <input type="number" id="minTemp" placeholder="Min"></label>
<label>Max Temp (Â°C): <input type="number" id="maxTemp" placeholder="Max"></label>
<button onclick="saveAlert()">Save</button>
</div>

<div class="cards">
<div class="card" id="tempCard"><h3>Temperature</h3><div class="value" id="cardTemp">-- Â°C</div></div>
<div class="card" id="humCard"><h3>Humidity</h3><div class="value" id="cardHum">-- %</div></div>
<div class="card" id="statusCard"><h3>Status</h3><div class="value" id="cardStatus">--</div></div>
</div>

<div id="map"></div>

<table>
<thead>
<tr><th>Date/Time</th><th>Temperature</th><th>Humidity</th><th>GPS</th><th>Status</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="pagination">
<button onclick="prevPage()">Previous</button>
<button onclick="nextPage()">Next</button>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
authDomain: "temperature-cold-guard.firebaseapp.com",
databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "temperature-cold-guard",
storageBucket: "temperature-cold-guard.firebasestorage.app",
messagingSenderId: "29693405672",
appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Check login
let role = localStorage.getItem("role");
if(!role){
    alert("à¸à¸£à¸¸à¸“à¸²à¸¥à¹‡à¸­à¸„à¸­à¸´à¸™à¸à¹ˆà¸­à¸™à¹€à¸‚à¹‰à¸² dashboard");
    window.location.href = 'login.html';
}
document.getElementById("roleLabel").innerText = role;

// Role-based colors
let roleColors = {Seller:"#4a90e2", Buyer:"#2ecc71", Driver:"#f39c12"};
let baseColor = roleColors[role] ?? "#4a90e2";
document.getElementById("header").style.background=baseColor;
document.querySelectorAll(".card").forEach(c=>c.style.background=baseColor);

// Show settings only for Seller
if(role==="Seller") document.getElementById("settings").style.display="block";

// Pagination
let page=0, pageSize=10, records=[];

// Leaflet map
const map=L.map('map').setView([13.736717,100.523186],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker=null;

// Alert thresholds
let minTemp=null, maxTemp=null;
const settingsRef=ref(db,"settings");
onValue(settingsRef,(snap)=>{
    const s=snap.val();
    if(s?.alertMinTemp!==undefined) minTemp=s.alertMinTemp;
    if(s?.alertMaxTemp!==undefined) maxTemp=s.alertMaxTemp;
    document.getElementById("minTemp").value=minTemp??"";
    document.getElementById("maxTemp").value=maxTemp??"";
});

// Load records
function loadRecords(){
    const recordsRef=ref(db,"records");
    onValue(recordsRef,(snap)=>{
        const data=snap.val();
        records=Object.entries(data||{}).reverse();
        updateCards(records[0]?.[1]);
        updateMap(records[0]?.[1]);
        renderPage();
    });
}

function updateCards(latest){
    if(!latest) return;
    const temp=latest.temperature, hum=latest.humidity;
    const status=latest.status;
    document.getElementById("cardTemp").innerText=temp+"Â°C";
    document.getElementById("cardHum").innerText=hum+"%";
    document.getElementById("statusCard").innerText=status;

    const tempCard=document.getElementById("tempCard");
    // Reset blink
    tempCard.classList.remove("blink");

    if(role==="Seller" && ((minTemp!==null && temp<minTemp) || (maxTemp!==null && temp>maxTemp))){
        tempCard.style.background=(temp>maxTemp)?"#e74c3c":"#2980b9"; // Red or dark blue
        tempCard.classList.add("blink"); // Start blinking
        // Play minion alert
        const audio=new Audio("https://www.myinstants.com/media/sounds/minion.mp3");
        audio.play();
    } else tempCard.style.background=baseColor;

    // Status card color
    const statusCard=document.getElementById("statusCard");
    statusCard.style.background=(status==="Warning")?"#e67e22":baseColor;

    // Humidity card
    const humCard=document.getElementById("humCard");
    humCard.style.background=baseColor;
}

function updateMap(latest){
    if(!latest || !latest.gps) return;
    const lat=latest.gps.lat, lng=latest.gps.lng;
    if(lat===undefined || lng===undefined) return;
    if(!marker) marker=L.marker([lat,lng]).addTo(map);
    else marker.setLatLng([lat,lng]);
    map.setView([lat,lng],13);
}

// Table & pagination
function renderPage(){
    const tbody=document.getElementById("tableBody"); tbody.innerHTML="";
    const start=page*pageSize, end=start+pageSize;
    const pageRecords=records.slice(start,end);
    pageRecords.forEach(([time,item])=>{
        tbody.innerHTML+=`<tr>
            <td>${time}</td>
            <td>${item.temperature}Â°C</td>
            <td>${item.humidity}%</td>
            <td>${item.gps?.lat}, ${item.gps?.lng}</td>
            <td>${item.status}</td>
        </tr>`;
    });
}
window.nextPage=()=>{page++;renderPage();}
window.prevPage=()=>{if(page>0) page--;renderPage();}

// Save alert thresholds
window.saveAlert=()=>{
    const min=parseFloat(document.getElementById("minTemp").value);
    const max=parseFloat(document.getElementById("maxTemp").value);
    update(ref(db,"settings"),{alertMinTemp:min,alertMaxTemp:max});
    alert("Saved!");
    minTemp=min; maxTemp=max;
}

loadRecords();
</script>
</body>
</html>
