<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {margin:0;font-family:Arial, sans-serif;background:#f7f9fc;color:#222;}
.center {display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
.role-btn{padding:12px 24px;margin:8px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;color:#fff;}
#dashboard{display:none;flex-direction:column;padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.header h1{margin:0;}
.logout-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#222;}
.logout-btn:hover{opacity:0.7;}
.card-container{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
.card{flex:1 1 200px;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;}
.card.seller{background:#f39c12;}
.card.driver{background:#3498db;}
.card.buyer{background:#2ecc71;}
.card.danger{background:#e74c3c;}
#map{height:350px;border-radius:12px;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;background:#fff;color:#222;border-radius:8px;overflow:hidden;}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:center;}
th{background:#ecf0f1;}
#settings{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input{padding:8px;width:100px;margin-right:10px;}
.alert {color:red;font-weight:bold;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="center">
<h1>ColdGuard Login</h1>
<button class="role-btn" style="background:#f39c12" onclick="loginAs('Seller')">Seller</button>
<button class="role-btn" style="background:#2ecc71" onclick="loginAs('Buyer')">Buyer</button>
<button class="role-btn" style="background:#3498db" onclick="loginAs('Driver')">Driver</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
  <div class="header">
    <h1>ColdGuard (<span id="roleLabel"></span>)</h1>
    <button class="logout-btn" onclick="logout()" title="Logout">ðŸšª</button>
  </div>

  <!-- Seller Settings -->
  <div id="settings" class="hidden">
    <h3>Temperature Alert Settings (Â°C)</h3>
    <label>Min: <input type="number" id="minTemp"></label>
    <label>Max: <input type="number" id="maxTemp"></label>
    <button onclick="saveTempSettings()">Save</button>
  </div>

  <div class="card-container">
    <div class="card" id="tempCard">Temperature: --</div>
    <div class="card" id="humCard" style="background:#95a5a6">Humidity: --</div>
    <div class="card" id="statusCard" style="background:#7f8c8d">Status: --</div>
  </div>

  <div id="map"></div>

  <h3>Trend Chart</h3>
  <canvas id="trendChart" height="200"></canvas>

  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg"></audio>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role = localStorage.getItem('role');
let minTemp=0, maxTemp=50;

// Auto-load dashboard if logged in
if(role){ showDashboard(); }

// Login function
window.loginAs = (r) => {
  localStorage.setItem('role', r);
  role = r;
  showDashboard();
};

// Logout
window.logout = () => {
  localStorage.removeItem('role');
  location.reload();
};

function showDashboard(){
  document.getElementById('login').style.display='none';
  document.getElementById('dashboard').style.display='flex';
  document.getElementById('roleLabel').textContent=role;

  const tempCard=document.getElementById('tempCard');
  tempCard.className='card '+role.toLowerCase();
  
  if(role==='Seller') document.getElementById('settings').classList.remove('hidden');

  initDashboard();
}

// Dashboard
let map, marker, chart, chartData={labels:[],datasets:[{label:'Temperature',data:[],borderColor:'#e74c3c',backgroundColor:'rgba(231,76,60,0.2)'}]};
function initDashboard(){
  map=L.map("map").setView([7.8804,98.3923],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  marker=L.marker([7.8804,98.3923]).addTo(map);

  // Chart
  const ctx=document.getElementById('trendChart').getContext('2d');
  chart=new Chart(ctx,{type:'line',data:chartData,options:{responsive:true,plugins:{legend:{display:false}}}});

  // Firebase listener
  onValue(ref(db,"records/latest"),snap=>{
    const data=snap.val();
    if(!data) return;
    document.getElementById("tempCard").textContent="Temperature: "+data.temperature+"Â°C";
    document.getElementById("humCard").textContent="Humidity: "+data.humidity+"%";
    document.getElementById("statusCard").textContent="Status: "+data.status;

    // Update Chart
    const now=new Date().toLocaleTimeString();
    chart.data.labels.push(now);
    chart.data.datasets[0].data.push(data.temperature);
    if(chart.data.labels.length>20){chart.data.labels.shift(); chart.data.datasets[0].data.shift();}
    chart.update();

    // Smooth map
    if(data.gps && data.gps.lat!=null && data.gps.lng!=null){
      marker.setLatLng([data.gps.lat,data.gps.lng]);
      map.panTo([data.gps.lat,data.gps.lng], {animate:true, duration:1});
    }

    // Alert Seller
    if(role==='Seller' && (data.temperature<minTemp || data.temperature>maxTemp)){
      document.getElementById('tempCard').classList.add('danger');
      document.getElementById('alertSound').play();
    } else {
      document.getElementById('tempCard').classList.remove('danger');
    }
  });
}

// Save temp settings
window.saveTempSettings = () => {
  minTemp = Number(document.getElementById('minTemp').value);
  maxTemp = Number(document.getElementById('maxTemp').value);
  update(ref(db,"settings"),{minTemp,maxTemp});
  alert("Saved!");
}
</script>
</body>
</html>
