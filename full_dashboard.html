<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {margin:0;font-family:Arial;background:#1b1b1b;color:#f5f5f5;}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px;}
.header h1{color:#f1c40f;margin:0;}
.logout-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#f1c40f;}
.card-container{display:flex;gap:20px;flex-wrap:wrap;padding:0 20px;margin-bottom:20px;}
.card{flex:1 1 200px;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;}
#map{height:350px;border-radius:12px;margin:0 20px 20px 20px;}
.seller { background:#f39c12; color:#111; }
.buyer { background:#2ecc71; color:#111; }
.driver { background:#3498db; color:#fff; }
</style>
</head>
<body>

<div class="header">
<h1>ColdGuard Dashboard (<span id="roleLabel"></span>)</h1>
<button class="logout-btn" onclick="logout()">ðŸšª</button>
</div>

<div class="card-container">
<div class="card seller" id="tempCard">Temperature: <span id="tempValue">--</span></div>
<div class="card seller" id="humCard">Humidity: <span id="humValue">--</span></div>
</div>

<div id="map"></div>

<h3 style="padding:0 20px;">Trend Chart</h3>
<canvas id="trendChart" height="200" style="margin:0 20px;"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
authDomain: "temperature-cold-guard.firebaseapp.com",
databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "temperature-cold-guard",
storageBucket: "temperature-cold-guard.firebasestorage.app",
messagingSenderId: "29693405672",
appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š role
let role = localStorage.getItem('role');
if(!role) window.location.href = 'login.html'; // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ role à¹ƒà¸«à¹‰à¸à¸¥à¸±à¸šà¹„à¸›à¸«à¸™à¹‰à¸² login

document.getElementById('roleLabel').textContent = role;

// à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸µ card à¸•à¸²à¸¡à¸šà¸—à¸šà¸²à¸—
const tempCard = document.getElementById('tempCard');
const humCard = document.getElementById('humCard');
if(role==='Seller'){ tempCard.className='card seller'; humCard.className='card seller'; }
else if(role==='Buyer'){ tempCard.className='card buyer'; humCard.className='card buyer'; }
else if(role==='Driver'){ tempCard.className='card driver'; humCard.className='card driver'; }

// âœ… Logout
window.logout = function(){
    localStorage.removeItem('role');
    window.location.href = 'login.html';
}

// Dashboard Map & Firebase
let map = L.map("map").setView([7.8804,98.3923],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker = L.marker([7.8804,98.3923]).addTo(map);

onValue(ref(db,"records/latest"), snap=>{
    const data = snap.val(); if(!data) return;
    const temp = data.temperature, hum = data.humidity;
    document.getElementById("tempValue").textContent=temp+" Â°C";
    document.getElementById("humValue").textContent=hum+" %";
});
onValue(ref(db,"records/latest/gps"), snap=>{
    const gps = snap.val(); if(!gps) return;
    marker.setLatLng([gps.lat,gps.lng]);
    map.setView([gps.lat,gps.lng]);
});
</script>

</body>
</html>
