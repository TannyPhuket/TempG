<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {margin:0;font-family:Arial,sans-serif;background:#f0f4f8;color:#333;}
header {padding:15px;text-align:center;font-size:24px;font-weight:bold;background:#3498db;color:#fff;}
#dashboard{padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.logout-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#3498db;}
.cards{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
.card{flex:1 1 200px;padding:20px;border-radius:10px;font-weight:bold;text-align:center;transition:0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#map, #trendChartContainer{height:350px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#sellerSettings{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.hidden{display:none;}
.toggle-btn{padding:8px 16px;margin:5px;background:#3498db;color:#fff;border:none;border-radius:5px;cursor:pointer;}
input[type=number]{padding:5px 8px;margin-right:10px;border:1px solid #ccc;border-radius:5px;}
button:hover{opacity:0.9;}
.card-temp{background:#f39c12;color:#fff;}
.card-hum{background:#2ecc71;color:#fff;}
.card-status{background:#3498db;color:#fff;}
.card-alert{background:#e74c3c;color:#fff;}
</style>
</head>
<body>

<header id="header">ColdGuard Dashboard</header>
<button class="logout-btn" onclick="logout()">ðŸšª Logout</button>

<div id="dashboard">
  <p><b>Role:</b> <span id="roleLabel"></span></p>

  <!-- Seller Only Settings -->
  <div id="sellerSettings" class="hidden">
    <h3>Temperature Alert Settings</h3>
    <input type="number" id="minTemp" placeholder="Min Â°C">
    <input type="number" id="maxTemp" placeholder="Max Â°C">
    <button onclick="saveTempSettings()">Save</button>
  </div>

  <!-- Cards -->
  <div class="cards">
    <div class="card card-temp" id="tempCard">Temperature: -- Â°C</div>
    <div class="card card-hum" id="humCard">Humidity: -- %</div>
    <div class="card card-status" id="statusCard">Status: --</div>
  </div>

  <!-- Toggle Map/Chart -->
  <button class="toggle-btn" onclick="showMap()">Show Map</button>
  <button class="toggle-btn" onclick="showTrend()">Show Trend</button>

  <!-- Map & Trend Chart -->
  <div id="map"></div>
  <div id="trendChartContainer" class="hidden">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<audio id="alertAudio" src="https://actions.google.com/sounds/v1/cartoon/minion_laugh.ogg"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Check login
const role = localStorage.getItem('role');
if(!role){ window.location.href='login.html'; }
document.getElementById('roleLabel').innerText = role;

// Seller settings
let alertMin = null;
let alertMax = null;
if(role==='Seller'){ document.getElementById('sellerSettings').classList.remove('hidden'); }
function saveTempSettings(){
  alertMin = Number(document.getElementById('minTemp').value);
  alertMax = Number(document.getElementById('maxTemp').value);
  alert('Saved!');
}

// Map
const map = L.map('map').setView([13.736717,100.523186],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;

// Trend Chart
const ctx = document.getElementById('trendChart').getContext('2d');
let chart = new Chart(ctx, {
    type:'line',
    data:{labels:[],datasets:[{label:'Temperature (Â°C)',data:[],borderColor:'#3498db',backgroundColor:'rgba(52,152,219,0.2)',fill:true}]} ,
    options:{
        responsive:true,
        animation:false,
        scales:{y:{beginAtZero:false}},
        plugins:{
            legend:{display:true},
            tooltip:{
                mode:'index',
                intersect:false,
                callbacks:{
                    label:function(context){
                        const idx = context.dataIndex;
                        const status = context.chart.data.datasets[0].statusData?.[idx] || '';
                        return `${context.dataset.label}: ${context.parsed.y} Â°C  | Status: ${status}`;
                    }
                }
            }
        }
    }
});

// Toggle
function showMap(){document.getElementById('map').classList.remove('hidden'); document.getElementById('trendChartContainer').classList.add('hidden');}
function showTrend(){document.getElementById('trendChartContainer').classList.remove('hidden'); document.getElementById('map').classList.add('hidden');}

// Load latest record
const recordsRef = ref(db,'records');
onValue(recordsRef, snap=>{
  const data = snap.val();
  if(!data) return;
  const entries = Object.entries(data).sort((a,b)=>new Date(a[0])-new Date(b[0]));
  const latest = entries[entries.length-1][1];

  const temp = latest.temperature;
  const hum = latest.humidity;
  const status = latest.status || 'OK';

  // Update cards
  const tempCard = document.getElementById('tempCard');
  const humCard = document.getElementById('humCard');
  const statusCard = document.getElementById('statusCard');

  tempCard.textContent = `Temperature: ${temp} Â°C`;
  humCard.textContent = `Humidity: ${hum} %`;
  statusCard.textContent = `Status: ${status}`;

  // Seller alert
  if(role==='Seller' && alertMin!==null && alertMax!==null){
      if(temp<alertMin || temp>alertMax){
          tempCard.className='card card-alert';
          document.getElementById('alertAudio').play();
      } else { tempCard.className='card card-temp'; }
  }

  // Map
  if(latest.gps){
    const lat = latest.gps.lat;
    const lng = latest.gps.lng;
    if(!marker) marker = L.marker([lat,lng]).addTo(map);
    else marker.setLatLng([lat,lng]);
    map.setView([lat,lng],13);
  }

  // Update trend chart
  const tempData = entries.map(e=>e[1].temperature);
  const labels = entries.map(e=>e[0]);
  const statusData = entries.map(e=>e[1].status || '');
  chart.data.labels = labels;
  chart.data.datasets[0].data = tempData;
  chart.data.datasets[0].statusData = statusData;
  chart.update();
});
</script>
</body>
</html>
