<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {margin:0;font-family:'Roboto',sans-serif;background:#f5f6fa;color:#2c3e50;}
header {background:#2980b9;color:#fff;padding:20px;font-size:22px;}
.container {padding:20px;max-width:1200px;margin:auto;}
.cards {display:flex;gap:20px;margin-bottom:20px;}
.card {flex:1;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center;transition:0.3s;}
.card.danger {background:#e74c3c;color:#fff;}
.card h3 {margin-bottom:10px;color:#555;}
.card .value {font-size:32px;font-weight:bold;}
#map {height:300px;border-radius:10px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
table {width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;margin-bottom:10px;}
th,td {padding:10px;border-bottom:1px solid #eee;text-align:center;}
th {background:#ecf0f1;}
button {padding:8px 16px;margin:0 5px;background:#2980b9;color:white;border:none;border-radius:5px;cursor:pointer;transition:0.3s;}
button:disabled {background:#aaa;}
.hidden {display:none;}
.alert {color:red;font-weight:bold;}
.settings {background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:20px;}
.logout-btn {float:right;font-size:18px;background:none;border:none;color:#fff;cursor:pointer;}
.role-seller {background:#f39c12;}
.role-buyer {background:#2ecc71;}
.role-driver {background:#3498db;}
</style>
</head>
<body>

<header>
ColdGuard Dashboard
<button class="logout-btn" onclick="logout()" title="Logout">ðŸšª Logout</button>
</header>

<div class="container">

<p><b>Role:</b> <span id="roleLabel"></span></p>

<div id="settings" class="settings hidden">
  <h3>Temperature Alert Setting (Seller)</h3>
  <input type="number" id="minTemp" placeholder="Min Â°C">
  <input type="number" id="maxTemp" placeholder="Max Â°C">
  <button onclick="saveAlert()">Save</button>
</div>

<div class="cards">
  <div class="card" id="tempCard"> 
    <h3>Temperature</h3> 
    <div class="value" id="cardTemp">-- Â°C</div>
  </div>
  <div class="card" id="humCard"> 
    <h3>Humidity</h3> 
    <div class="value" id="cardHum">-- %</div>
  </div>
  <div class="card" id="statusCard"> 
    <h3>Status</h3> 
    <div class="value" id="cardStatus">--</div>
  </div>
</div>

<div id="map"></div>

<table>
  <thead>
    <tr>
      <th>Date/Time</th>
      <th>Temperature</th>
      <th>Humidity</th>
      <th>GPS</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div class="pagination">
  <button onclick="prevPage()">Previous</button>
  <button onclick="nextPage()">Next</button>
</div>

<audio id="alarmSound">
  <source src="minion_alarm.mp3" type="audio/mpeg">
</audio>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let role = localStorage.getItem('role');
if(!role){window.location.href='login.html';}
document.getElementById("roleLabel").innerText = role;

// Role-based settings
if(role==="Seller"){ document.getElementById("settings").classList.remove("hidden"); }

let page=0, pageSize=10, records=[];
const map = L.map('map').setView([13.736717,100.523186],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker=null;

const alarm = document.getElementById("alarmSound");

// Load records
function loadRecords(){
  const recordsRef = ref(db,"records");
  onValue(recordsRef,snap=>{
    const data=snap.val();
    records = Object.entries(data||{}).reverse();
    updateCards(records[0]?.[1]);
    updateMap(records[0]?.[1]);
    renderPage();
  });
}

function updateCards(latest){
  if(!latest) return;
  const temp = latest.temperature;
  document.getElementById("cardTemp").innerText = temp+" Â°C";
  document.getElementById("cardHum").innerText = latest.humidity+" %";
  document.getElementById("cardStatus").innerText = latest.status;

  // Check alert for Seller
  if(role==="Seller"){
    const minT = Number(document.getElementById("minTemp").value);
    const maxT = Number(document.getElementById("maxTemp").value);
    if((minT && temp<minT) || (maxT && temp>maxT)){
      document.getElementById("tempCard").classList.add("danger");
      alarm.play();
    } else {
      document.getElementById("tempCard").classList.remove("danger");
      alarm.pause();
      alarm.currentTime=0;
    }
  }
}

function updateMap(latest){
  if(!latest || !latest.gps) return;
  const lat = latest.gps.lat;
  const lng = latest.gps.lng;
  if(lat===undefined || lng===undefined) return;
  if(!marker) marker = L.marker([lat,lng]).addTo(map);
  else marker.setLatLng([lat,lng]);
  map.setView([lat,lng],13);
}

function renderPage(){
  const tbody=document.getElementById("tableBody");
  tbody.innerHTML="";
  const start=page*pageSize,end=start+pageSize;
  const pageRecords=records.slice(start,end);
  pageRecords.forEach(([time,item])=>{
    tbody.innerHTML+=`<tr>
      <td>${time}</td>
      <td>${item.temperature}Â°C</td>
      <td>${item.humidity}%</td>
      <td>${item.gps.lat}, ${item.gps.lng}</td>
      <td>${item.status}</td>
    </tr>`;
  });
}

window.nextPage=()=>{page++;renderPage();}
window.prevPage=()=>{if(page>0) page--;renderPage();}

window.saveAlert=()=>{
  const minT = Number(document.getElementById("minTemp").value);
  const maxT = Number(document.getElementById("maxTemp").value);
  update(ref(db,"settings"),{minTemp,maxTemp});
  alert("Alert settings saved!");
}

window.logout=()=>{
  localStorage.removeItem('role');
  window.location.href='login.html';
}

loadRecords();
</script>

</body>
</html>
