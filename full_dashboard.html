<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cold Guard Dashboard</title>

    <!-- ✅ Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- ✅ Simple CSS -->
    <style>
        body { font-family: Arial; margin: 0; background: #f5f5f5; }
        h3 { margin-bottom: 10px; }
        .card-container {
            display: flex; gap: 20px; padding: 20px;
        }
        .card {
            flex: 1;
            background: #4cd964; padding: 20px; border-radius: 12px;
            color: white; font-size: 20px; font-weight: bold; text-align: center;
        }
        .container { padding: 20px; }
        table {
            width: 100%; border-collapse: collapse; background: white;
            border-radius: 8px; overflow: hidden;
        }
        th, td {
            padding: 10px; border-bottom: 1px solid #ddd; text-align: center;
        }
        th { background: #222; color: white; }
        #map { height: 350px; border-radius: 12px; }
        .controls button {
            margin-left: 8px; padding: 5px 12px;
        }
    </style>

    <!-- ✅ Firebase -->
    <script type="module">
        // ✅ Firebase Config (แก้ให้ตรงของคุณ)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
            authDomain: "temperature-cold-guard.firebaseapp.com",
            databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "temperature-cold-guard",
            storageBucket: "temperature-cold-guard.firebasestorage.app",
            messagingSenderId: "29693405672",
            appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ✅ ตัวแปร Max–Min (แก้ได้ตามต้องการ)
        let maxTemp = 10;
        let minTemp = 2;

        // ✅ แจ้งเตือนครั้งเดียว
        let alertSent = false;

        if ("Notification" in window) {
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // ✅ ดึงข้อมูลล่าสุดแบบ Real-Time
        onValue(ref(db, "records/latest"), snap => {
            const data = snap.val();
            if (!data) return;

            const temp = data.temperature;
            const hum = data.humidity;

            document.getElementById("tempValue").textContent = temp + " °C";
            document.getElementById("humValue").textContent = hum + " %";

            // ✅ เช็ค Max–Min
            if (temp > maxTemp || temp < minTemp) {
                document.getElementById("tempCard").style.background = "#ff4d4d";

                if (!alertSent && Notification.permission === "granted") {
                    new Notification("⚠️ Cold Guard Alert", {
                        body: temp > maxTemp
                            ? `Temperature สูงเกิน ${maxTemp}°C`
                            : `Temperature ต่ำกว่า ${minTemp}°C`
                    });
                    alertSent = true;
                }
            } else {
                document.getElementById("tempCard").style.background = "#4cd964";
                alertSent = false;
            }
        });

        // ✅ MAP Setup
        let map = L.map("map").setView([7.8804, 98.3923], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        let marker = L.marker([7.8804, 98.3923]).addTo(map);

        // ✅ GPS Real-Time
        onValue(ref(db, "records/latest/gps"), snap => {
            const gps = snap.val();
            if (!gps) return;
            marker.setLatLng([gps.lat, gps.lng]);
            map.setView([gps.lat, gps.lng]);
        });

        // ✅ ตารางย้อนหลังแบบอัปเกรด
        let allRows = [];
        let filteredRows = [];
        let currentPage = 1;
        const rowsPerPage = 10;

        // ✅ โหลดข้อมูลทั้งหมด
        async function loadHistory() {
            const snap = await get(ref(db, "records"));
            const data = snap.val();
            if (!data) return;

            allRows = [];

            Object.keys(data).forEach(key => {
                const item = data[key];
                allRows.push({
                    time: item.timestamp,
                    temp: item.temperature,
                    hum: item.humidity
                });
            });

            // ✅ เรียงใหม่ → เก่า
            allRows.sort((a, b) => b.time - a.time);

            filteredRows = [...allRows];
            renderTable();
        }

        // ✅ แสดงผลตามหน้า
        function renderTable() {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageRows = filteredRows.slice(start, end);

            let html = "";
            pageRows.forEach(r => {
                const date = new Date(r.time).toLocaleString();
                const highlight = (r.temp > maxTemp || r.temp < minTemp) ? "style='background:#ffb3b3;'" : "";
                html += `
                    <tr ${highlight}>
                        <td>${date}</td>
                        <td>${r.temp}</td>
                        <td>${r.hum}</td>
                    </tr>
                `;
            });

            document.getElementById("historyBody").innerHTML = html;
            document.getElementById("pageInfo").textContent =
                `Page ${currentPage} / ${Math.ceil(filteredRows.length / rowsPerPage)}`;
        }

        // ✅ Pagination Controls
        window.nextPage = function() {
            if (currentPage * rowsPerPage < filteredRows.length) {
                currentPage++;
                renderTable();
            }
        }

        window.prevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        // ✅ Filter by Date
        window.applyFilter = function() {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            filteredRows = allRows.filter(r => {
                const d = new Date(r.time).toISOString().split("T")[0];
                return (!start || d >= start) && (!end || d <= end);
            });

            currentPage = 1;
            renderTable();
        }

        window.resetFilter = function() {
            filteredRows = [...allRows];
            currentPage = 1;
            renderTable();
        }

        // ✅ Export CSV
        window.exportCSV = function() {
            let csv = "Timestamp,Temperature,Humidity\n";
            filteredRows.forEach(r => {
                csv += `${new Date(r.time).toLocaleString()},${r.temp},${r.hum}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "history_records.csv";
            link.click();
        }

        loadHistory();
    </script>

</head>
<body>

    <!-- ✅ Dashboard Cards -->
    <div class="card-container">
        <div class="card" id="tempCard">
            Temperature: <span id="tempValue">--</span>
        </div>

        <div class="card" style="background:#007aff;">
            Humidity: <span id="humValue">--</span>
        </div>
    </div>

    <!-- ✅ MAP -->
    <div class="container">
        <h3>Location</h3>
        <div id="map"></div>
    </div>

    <!-- ✅ History Table -->
    <div class="container">
        <h3>History Records</h3>

        <!-- ✅ Filter -->
        <label>Start Date:</label>
        <input type="date" id="startDate">

        <label>End Date:</label>
        <input type="date" id="endDate">

        <div class="controls" style="margin-top:10px;">
            <button onclick="applyFilter()">Filter</button>
            <button onclick="resetFilter()">Reset</button>
            <button onclick="exportCSV()">Export CSV</button>
        </div>

        <!-- ✅ Table -->
        <table style="margin-top:15px;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Temperature (°C)</th>
                    <th>Humidity (%)</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>

        <!-- ✅ Pagination -->
        <div style="margin-top:10px;">
            <button onclick="prevPage()">Prev</button>
            <span id="pageInfo"></span>
            <button onclick="nextPage()">Next</button>
        </div>
    </div>

</body>
</html>
