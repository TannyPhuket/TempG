<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdGuard Dashboard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {margin:0;font-family:Arial;background:#1b1b1b;color:#f5f5f5;}
.header{display:flex;justify-content:space-between;align-items:center;padding:15px;background:#222;color:#f1c40f;}
.header h1{margin:0;}
.logout-btn{background:none;border:none;font-size:22px;cursor:pointer;color:#f1c40f;}
.logout-btn:hover{opacity:0.7;}
.container{padding:20px;}
.cards{display:flex;gap:20px;margin-bottom:20px;}
.card{flex:1 1 150px;background:#27ae60;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;transition:0.3s;}
.card.danger{background:#e74c3c;}
#map{height:300px;border-radius:12px;margin-bottom:20px;}
input[type=number]{padding:6px;width:80px;margin-right:10px;}
button.save-btn{padding:6px 12px;background:#f1c40f;color:#1b1b1b;border:none;border-radius:6px;cursor:pointer;}
button.save-btn:hover{background:#e0b90f;}
#alertBox{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#e74c3c;color:#fff;padding:15px 25px;border-radius:10px;font-size:18px;font-weight:bold;z-index:9999;display:none;}
.hidden{display:none;}
</style>
</head>
<body>

<div class="header">
  <h1>ColdGuard Dashboard (<span id="roleLabel"></span>)</h1>
  <button class="logout-btn" onclick="logout()">üö™</button>
</div>

<div class="container">

  <!-- ‚úÖ Seller Settings -->
  <div id="settings" class="hidden" style="margin-bottom:20px;">
    <h3>Temperature Alert Settings</h3>
    Min: <input type="number" id="minTemp" placeholder="¬∞C">
    Max: <input type="number" id="maxTemp" placeholder="¬∞C">
    <button class="save-btn" onclick="saveAlertSettings()">Save</button>
  </div>

  <!-- ‚úÖ Cards -->
  <div class="cards">
    <div class="card" id="tempCard">Temperature: -- ¬∞C</div>
    <div class="card" id="humCard" style="background:#f1c40f;">Humidity: -- %</div>
    <div class="card" id="statusCard">Status: --</div>
  </div>

  <!-- ‚úÖ Map -->
  <div id="map"></div>

  <!-- ‚úÖ Alert Box -->
  <div id="alertBox">‚ö†Ô∏è Temperature Alert!</div>

</div>

<!-- Audio -->
<audio id="alertSound" src="https://actions.google.com/sounds/v1/cartoon/minion_toot.ogg"></audio>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Role from localStorage
let role = localStorage.getItem('role');
if(!role){
  window.location.href="login.html"; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô
}
document.getElementById('roleLabel').textContent = role;

// ‚úÖ Show Seller Settings
if(role === "Seller"){
  document.getElementById("settings").classList.remove("hidden");
}

// ‚úÖ Map Setup
let map = L.map('map').setView([7.8804,98.3923],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker = L.marker([7.8804,98.3923]).addTo(map);

// ‚úÖ Alert Elements
const alertBox = document.getElementById("alertBox");
const alertSound = document.getElementById("alertSound");

let minTemp = null;
let maxTemp = null;

// ‚úÖ Load Alert Settings from Firebase
onValue(ref(db,"settings/alertTemperature"), snap=>{
  const val = snap.val();
  if(val){
    minTemp = val.min || null;
    maxTemp = val.max || null;
    document.getElementById("minTemp").value = minTemp;
    document.getElementById("maxTemp").value = maxTemp;
  }
});

// ‚úÖ Save Alert Settings
window.saveAlertSettings = () => {
  const min = Number(document.getElementById("minTemp").value);
  const max = Number(document.getElementById("maxTemp").value);
  minTemp = min;
  maxTemp = max;
  update(ref(db,"settings/alertTemperature"),{min,max});
  alert("Saved!");
};

// ‚úÖ Logout
window.logout = () => {
  localStorage.removeItem('role');
  window.location.href="login.html";
};

// ‚úÖ Monitor Temperature & Humidity
onValue(ref(db,"records/latest"), snap=>{
  const data = snap.val();
  if(!data) return;
  const temp = data.temperature;
  const hum = data.humidity;
  const status = data.status;

  document.getElementById("tempCard").textContent = "Temperature: "+temp+" ¬∞C";
  document.getElementById("humCard").textContent = "Humidity: "+hum+" %";
  document.getElementById("statusCard").textContent = "Status: "+status;

  // ‚úÖ Alert Logic
  if(role==="Seller" && ((minTemp!==null && temp<minTemp) || (maxTemp!==null && temp>maxTemp))){
    document.getElementById("tempCard").classList.add("danger");
    alertBox.style.display = "block";
    if(alertSound.paused){ alertSound.loop=true; alertSound.play();}
  } else {
    document.getElementById("tempCard").classList.remove("danger");
    alertBox.style.display = "none";
    if(!alertSound.paused){ alertSound.pause(); alertSound.currentTime=0;}
  }
});

// ‚úÖ Update GPS Marker
onValue(ref(db,"records/latest/gps"), snap=>{
  const gps = snap.val();
  if(!gps) return;
  marker.setLatLng([gps.lat,gps.lng]);
  map.setView([gps.lat,gps.lng]);
});

</script>

</body>
</html>
