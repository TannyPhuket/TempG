<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart cool Guard</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial; display:flex; min-height:100vh; background:#1b1b1b; color:#f5f5f5; }
/* Sidebar */
.sidebar{width:220px;background:#2c2f33;display:flex;flex-direction:column;padding-top:20px;}
.sidebar h2{color:#f1c40f;text-align:center;margin-bottom:30px;}
.sidebar a{color:#ddd;padding:12px 20px;text-decoration:none;display:block;margin-bottom:5px;border-left:4px solid transparent;}
.sidebar a.active,.sidebar a:hover{background:#3e3e3e;border-left:4px solid #f1c40f;color:#fff;}
/* Main */
.main{flex:1;padding:20px;overflow-y:auto;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.header h1{font-size:24px;color:#f1c40f;margin:0;}
.header button{background:#f1c40f;border:none;padding:8px 16px;cursor:pointer;font-weight:bold;color:#1b1b1b;border-radius:4px;}
.card-container{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;}
.card{flex:1 1 200px;background:#27ae60;padding:20px;border-radius:10px;color:#fff;font-weight:bold;text-align:center;transition:0.3s;}
.card.warning{background:#f39c12;}
.card.danger{background:#e74c3c;}
#map{height:350px;border-radius:12px;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;background:#2c2f33;color:#fff;border-radius:8px;overflow:hidden;}
th,td{padding:10px;border-bottom:1px solid #444;text-align:center;}
th{background:#3e3e3e;}
tr.highlight{background:#e74c3c33;}
.controls button{margin-left:8px;padding:6px 12px;border-radius:4px;border:none;background:#f1c40f;color:#1b1b1b;cursor:pointer;}
input[type="date"],input[type="number"]{padding:5px;border-radius:4px;border:none;margin-right:5px;}
#settings{margin-top:20px;display:none;}
@media(max-width:768px){.card-container{flex-direction:column;}.sidebar{width:100%;flex-direction:row;overflow-x:auto;}.sidebar a{flex:1;border-left:none;text-align:center;}body{flex-direction:column;}}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
<h2>ColdGuard</h2>
<a href="#" class="active">Dashboard</a>
<a href="#live">Live Data</a>
<a href="#mapSection">Location</a>
<a href="#historySection">History</a>
<a href="#settings">Settings</a>
</div>

<!-- Main -->
<div class="main">
<div class="header">
<h1>ColdGuard Monitoring</h1>
<button onclick="toggleTheme()">Toggle Theme</button>
</div>

<!-- Dashboard Cards -->
<div class="card-container">
<div class="card" id="tempCard">Temperature: <span id="tempValue">--</span></div>
<div class="card" id="humCard" style="background:#f1c40f;">Humidity: <span id="humValue">--</span></div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- History -->
<div id="historySection">
<h3>History Records</h3>
<label>Start Date:</label><input type="date" id="startDate">
<label>End Date:</label><input type="date" id="endDate">
<div class="controls" style="margin-top:10px;">
<button onclick="applyFilter()">Filter</button>
<button onclick="resetFilter()">Reset</button>
<button onclick="exportCSV()">Export CSV</button>
</div>
<table style="margin-top:15px;">
<thead><tr><th>Timestamp</th><th>Temperature (°C)</th><th>Humidity (%)</th></tr></thead>
<tbody id="historyBody"></tbody>
</table>
<div style="margin-top:10px;">
<button onclick="prevPage()">Prev</button>
<span id="pageInfo"></span>
<button onclick="nextPage()">Next</button>
</div>
</div>

<!-- Settings (Seller Only) -->
<div id="settings">
<h3>Settings (Seller Only)</h3>
<label>Max Temp:</label><input type="number" id="maxTempInput" value="10">
<label>Min Temp:</label><input type="number" id="minTempInput" value="2">
<button onclick="saveSettings()">Save</button>
</div>

</div>

<!-- Scripts -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

// ✅ Firebase Config
const firebaseConfig = {
apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
authDomain: "temperature-cold-guard.firebaseapp.com",
databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "temperature-cold-guard",
storageBucket: "temperature-cold-guard.firebasestorage.app",
messagingSenderId: "29693405672",
appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Role
const role = localStorage.getItem('role') || 'Buyer';
console.log("Role:", role);
if(role==='Seller'){ document.getElementById('settings').style.display='block'; }

// Max-Min
let maxTemp=parseFloat(document.getElementById('maxTempInput').value);
let minTemp=parseFloat(document.getElementById('minTempInput').value);
let alertSent=false;
if("Notification" in window && Notification.permission!=="granted"){Notification.requestPermission();}

// Real-Time Data
onValue(ref(db,"records/latest"), snap=>{
const data=snap.val(); if(!data) return;
const temp=data.temperature; const hum=data.humidity;
document.getElementById("tempValue").textContent=temp+" °C";
document.getElementById("humValue").textContent=hum+" %";
const tempCard=document.getElementById("tempCard");
if(temp>maxTemp||temp<minTemp){
tempCard.className="card danger";
if(!alertSent && Notification.permission==="granted"){new Notification("⚠️ Cold Guard Alert",{body: temp>maxTemp?`Temperature สูงเกิน ${maxTemp}°C`:`Temperature ต่ำกว่า ${minTemp}°C`});alertSent=true;}
}else{tempCard.className="card";alertSent=false;}
});

// Map
let map=L.map("map").setView([7.8804,98.3923],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let marker=L.marker([7.8804,98.3923]).addTo(map);
onValue(ref(db,"records/latest/gps"), snap=>{const gps=snap.val();if(!gps)return;marker.setLatLng([gps.lat,gps.lng]);map.setView([gps.lat,gps.lng]);});

// History Table
let allRows=[],filteredRows=[],currentPage=1,rowsPerPage=10;
async function loadHistory(){
    const snap=await get(ref(db,"records"));
    const data=snap.val(); if(!data) return;
    allRows=[];
    Object.keys(data).forEach(key=>{const item=data[key];allRows.push({time:item.timestamp,temp:item.temperature,hum:item.humidity});});
    allRows.sort((a,b)=>b.time-b.time);
    // Role Filter
    if(role==='Driver'){ const sevenDaysAgo=new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7); filteredRows=allRows.filter(r=>new Date(r.time)>=sevenDaysAgo);}
    else{filteredRows=[...allRows];}
    renderTable();
}
function renderTable(){
    const start=(currentPage-1)*rowsPerPage;
    const end=start+rowsPerPage;
    const pageRows=filteredRows.slice(start,end);
    let html="";
    pageRows.forEach(r=>{
        const date=new Date(r.time).toLocaleString();
        const highlight=(r.temp>maxTemp||r.temp<minTemp)? "class='highlight'":"";
        html+=`<tr ${highlight}><td>${date}</td><td>${r.temp}</td><td>${r.hum}</td></tr>`;
    });
    document.getElementById("historyBody").innerHTML=html;
    document.getElementById("pageInfo").textContent=`Page ${currentPage} / ${Math.ceil(filteredRows.length/rowsPerPage)}`;
}
window.nextPage=function(){if(currentPage*rowsPerPage<filteredRows.length){currentPage++;renderTable();}}
window.prevPage=function(){if(currentPage>1){currentPage--;renderTable();}}
window.applyFilter=function(){const start=document.getElementById("startDate").value;const end=document.getElementById("endDate").value;
filteredRows=allRows.filter(r=>{const d=new Date(r.time).toISOString().split("T")[0];return (!start||d>=start)&&(!end||d<=end);});currentPage=1;renderTable();}
window.resetFilter=function(){filteredRows=[...allRows];currentPage=1;renderTable();}
window.exportCSV=function(){let csv="Timestamp,Temperature,Humidity\n";filteredRows.forEach(r=>{csv+=`${new Date(r.time).toLocaleString()},${r.temp},${r.hum}\n`;});const blob=new Blob([csv],{type:"text/csv"});const link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download="history_records.csv";link.click();}

function saveSettings(){
    const max=parseFloat(document.getElementById('maxTempInput').value);
    const min=parseFloat(document.getElementById('minTempInput').value);
    if(max<=min){ alert("Max must be > Min"); return; }
    maxTemp=max; minTemp=min;
    set(ref(db,"setting/alertTemperature"), {max,maxTemp:minTemp});
    alert("Settings saved!");
}

function toggleTheme(){
    const body=document.body;
    if(body.style.background==="#f5f5f5"){body.style.background="#1b1b1b";body.style.color="#f5f5f5";}
    else{body.style.background="#f5f5f5";body.style.color="#1b1b1b";}
}

loadHistory();
</script>

</body>
</html>
