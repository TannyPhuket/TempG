<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Buyer Dashboard</title>
<link rel="stylesheet" href="styles.css" />
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
</head>
<body>
<div class="sidebar">
  <a href="#"><span class="icon">ğŸ </span> Dashboard</a>
  <a href="#"><span class="icon">ğŸŒ¡ï¸</span> Temperature</a>
  <a href="#"><span class="icon">ğŸ’§</span> Humidity</a>
  <a href="#"><span class="icon">ğŸ“</span> GPS</a>
  <a href="login.html"><span class="icon">ğŸ”“</span> Logout</a>
</div>

<div id="siren"></div>

<div class="main">
  <h2 class="title">Buyer Dashboard</h2>
  <div class="grid">
    <div class="card" id="tempCard">
      <h3><span class="icon">ğŸŒ¡ï¸</span> à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´</h3>
      <div id="temp" class="value">-- Â°C</div>
    </div>
    <div class="card">
      <h3><span class="icon">ğŸ’§</span> à¸„à¸§à¸²à¸¡à¸Šà¸·à¹‰à¸™</h3>
      <div id="hum" class="value">-- %</div>
    </div>
    <div class="card">
      <h3><span class="icon">ğŸ“</span> à¹à¸œà¸™à¸—à¸µà¹ˆà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸ªà¸´à¸™à¸„à¹‰à¸²</h3>
      <div id="map" class="map-container"></div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="chartTempHum"></canvas>
  </div>
</div>

<audio id="sirenAudio" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_notifications.ogg"></audio>

<script type="module">
import { db, ref, onValue } from './firebase-config.js';

// Config
const TEMP_THRESHOLD=30;
const tempElem=document.getElementById("temp");
const humElem=document.getElementById("hum");
const tempCard=document.getElementById("tempCard");
const sirenElem=document.getElementById("siren");
const sirenAudio=document.getElementById("sirenAudio");

// Chart
const ctx=document.getElementById('chartTempHum').getContext('2d');
const chartData={labels:[], datasets:[
  {label:'Temperature (Â°C)', data:[], borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,0.2)', tension:0.4},
  {label:'Humidity (%)', data:[], borderColor:'#14b8a6', backgroundColor:'rgba(20,184,166,0.2)', tension:0.4}
]};
const chart=new Chart(ctx,{type:'line', data:chartData, options:{responsive:true, scales:{ x:{ ticks:{ color:'#111' } }, y:{ ticks:{ color:'#111' } } }, plugins:{ legend:{ labels:{ color:'#111' } } } }});

// Map
let map, marker;
function initMap(lat=14.1234,lng=100.1234){ map=new google.maps.Map(document.getElementById('map'),{zoom:12,center:{lat,lng}}); marker=new google.maps.Marker({position:{lat,lng},map}); }
initMap();

// Realtime
onValue(ref(db,'Data/Temperature'),snap=>{
  const val=snap.val();
  tempElem.textContent=val+" Â°C";
  updateChart(val,null);
  if(val>TEMP_THRESHOLD){ tempElem.classList.add("alert"); tempCard.classList.add("alert"); sirenElem.style.display="block"; sirenAudio.play(); }
  else{ tempElem.classList.remove("alert"); tempCard.classList.remove("alert"); sirenElem.style.display="none"; sirenAudio.pause(); sirenAudio.currentTime=0; }
});
onValue(ref(db,'Data/Humidity'),snap=>{
  const val=snap.val();
  humElem.textContent=val+" %";
  updateChart(null,val);
});
onValue(ref(db,'Data/GPS'),snap=>{
  const val=snap.val();
  if(val && val.lat!==undefined && val.lng!==undefined){ marker.setPosition({lat:val.lat,lng:val.lng}); map.setCenter({lat:val.lat,lng:val.lng}); }
});

function updateChart(temp,hum){
  const now=new Date(); const label=now.getHours()+":"+now.getMinutes()+":"+now.getSeconds();
  chartData.labels.push(label);
  chartData.datasets[0].data.push(temp!==null?temp:null);
  chartData.datasets[1].data.push(hum!==null?hum:null);
  if(chartData.labels.length>20){ chartData.labels.shift(); chartData.datasets[0].data.shift(); chartData.datasets[1].data.shift(); }
  chart.update();
}
</script>
</body>
</html>
