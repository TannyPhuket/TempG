<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cold Guard Dashboard</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #f5f7fa;
}
.navbar {
    background: #0057ff;
    color: white;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    font-size: 18px;
}
.container { padding: 25px; }
.cards { display: flex; gap: 20px; margin-bottom: 25px; }
.card {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    text-align: center;
    font-size: 20px;
}
#map {
    width: 100%;
    height: 300px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
table {
    width: 100%;
    background: white;
    border-collapse: collapse;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
th { background: #e9f1ff; }
.settings-btn {
    padding: 10px 20px;
    background: #ff9d00;
    border: none;
    color: white;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 20px;
    display: none; /* Default ‡∏ã‡πà‡∏≠‡∏ô */
}
.pagination { margin-top: 15px; text-align: center; }
.pagination button {
    padding: 6px 12px;
    margin: 0 5px;
    border: none;
    border-radius: 5px;
    background: #0057ff;
    color: white;
    cursor: pointer;
}
.pagination button:disabled { background: #aaa; cursor: not-allowed; }
</style>
</head>
<body>

<div class="navbar">
    <div>Cold Guard Dashboard</div>
    <div id="roleDisplay"></div>
</div>

<div class="container">
    <button id="settingsBtn" class="settings-btn">‚öô ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>

    <div class="cards">
        <div class="card">
            üå° ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
            <div id="tempValue" style="font-size:34px; font-weight:bold;">-- ¬∞C</div>
        </div>
        <div class="card">
            üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
            <div id="humidityValue" style="font-size:34px; font-weight:bold;">-- %</div>
        </div>
        <div class="card">
            ‚ö†Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            <div id="statusValue" style="font-size:28px; font-weight:bold;">--</div>
        </div>
    </div>

    <div id="map"></div>

    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>

    <table>
        <thead>
            <tr>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</th>
                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>GPS</th>
            </tr>
        </thead>
        <tbody id="historyTable"></tbody>
    </table>

    <div class="pagination">
        <button id="prevBtn" onclick="prevPage()">Previous</button>
        <button id="nextBtn" onclick="nextPage()">Next</button>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, query, orderByKey, limitToLast, startAt, endAt } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  authDomain: "temperature-cold-guard.firebaseapp.com",
  databaseURL: "https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "temperature-cold-guard",
  storageBucket: "temperature-cold-guard.firebasestorage.app",
  messagingSenderId: "29693405672",
  appId: "1:29693405672:web:9815de4ba98e7e4cf3dc5d",
  measurementId: "G-XDHBRJ9S3W"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á Role
const role = localStorage.getItem("userRole") || "Buyer";
document.getElementById("roleDisplay").textContent = "Role: " + role;

// 2Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seller
if(role === "Seller") {
    document.getElementById("settingsBtn").style.display = "inline-block";
}

// 3Ô∏è‚É£ Leaflet Map
const map = L.map('map').setView([13.736717, 100.523186], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
let marker = null;

// 4Ô∏è‚É£ Pagination
let page = 0;
const pageSize = 10;
let historyRecords = []; // [{key, data}, ...]

// 5Ô∏è‚É£ ‡∏î‡∏∂‡∏á latest
const latestRef = ref(db, 'latest');
onValue(latestRef, snap => {
    const data = snap.val();
    if(data) {
        document.getElementById("tempValue").textContent = data.temperature + " ¬∞C";
        document.getElementById("humidityValue").textContent = data.humidity + " %";
        document.getElementById("statusValue").textContent = data.status;

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô Map
        if(data.gps){
            const {lat,lng} = data.gps;
            if(!marker){
                marker = L.marker([lat,lng]).addTo(map);
            } else marker.setLatLng([lat,lng]);
            map.setView([lat,lng], 13);
        }
    }
});

// 6Ô∏è‚É£ ‡∏î‡∏∂‡∏á records_by_day (30 ‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ 7 ‡∏ß‡∏±‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Driver)
const today = new Date();
const daysToFetch = (role === "Driver") ? 7 : 30;
let dayKeys = [];
for(let i=0; i<daysToFetch; i++){
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    dayKeys.push(d.toISOString().slice(0,10)); // "YYYY-MM-DD"
}

const historyPromises = dayKeys.map(dayKey => {
    const dayRef = ref(db, `records_by_day/${dayKey}`);
    return new Promise(resolve => {
        onValue(dayRef, snap => {
            const val = snap.val();
            if(val){
                for(const key in val){
                    historyRecords.push({key, data: val[key]});
                }
            }
            resolve();
        });
    });
});

Promise.all(historyPromises).then(() => {
    // sort ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
    historyRecords.sort((a,b) => new Date(b.key) - new Date(a.key));
    renderPage();
});

function renderPage(){
    const tbody = document.getElementById("historyTable");
    tbody.innerHTML = "";
    const start = page * pageSize;
    const end = start + pageSize;
    const pageRecords = historyRecords.slice(start,end);
    pageRecords.forEach(r => {
        const {temperature, humidity, status, gps} = r.data;
        tbody.innerHTML += `
            <tr>
                <td>${r.key}</td>
                <td>${temperature} ¬∞C</td>
                <td>${humidity} %</td>
                <td>${status}</td>
                <td>${gps ? gps.lat+', '+gps.lng : '--'}</td>
            </tr>
        `;
    });

    // ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° pagination
    document.getElementById("prevBtn").disabled = page===0;
    document.getElementById("nextBtn").disabled = end>=historyRecords.length;
}

window.nextPage = () => { page++; renderPage(); }
window.prevPage = () => { page--; renderPage(); }

</script>
</body>
</html>
