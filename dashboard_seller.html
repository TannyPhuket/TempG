<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Seller Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <div class="max-w-3xl mx-auto mt-10">

    <h1 class="text-3xl font-bold mb-6">Seller Dashboard</h1>

    <!-- ข้อมูลเซ็นเซอร์แบบเรียลไทม์ -->
    <div class="p-4 bg-white rounded shadow">
      <h2 class="text-xl font-bold mb-4">ข้อมูลอุณหภูมิ</h2>

      <p>อุณหภูมิ: <span id="temp" class="font-semibold text-red-600">--</span> °C</p>
      <p>ความชื้น: <span id="hum" class="font-semibold text-blue-600">--</span> %</p>
      <p>เวลาอัปเดต: <span id="time" class="font-semibold">--</span></p>
    </div>

    <!-- ตั้งค่าการแจ้งเตือน -->
    <div class="p-4 bg-white rounded shadow mt-6">
      <h2 class="text-xl font-bold mb-4">ตั้งค่าอุณหภูมิแจ้งเตือน</h2>

      <div>
        <label>อุณหภูมิต่ำสุด (°C)</label>
        <input id="minTemp" type="number" class="border p-2 w-full rounded" placeholder="เช่น 25">
      </div>

      <div class="mt-3">
        <label>อุณหภูมิสูงสุด (°C)</label>
        <input id="maxTemp" type="number" class="border p-2 w-full rounded" placeholder="เช่น 30">
      </div>

      <div class="mt-3">
        <label>เบอร์โทรสำหรับแจ้งเตือน (คั่นด้วย ,)</label>
        <input id="phones" type="text" class="border p-2 w-full rounded" placeholder="เช่น 66811360092,66876543210">
      </div>

      <button onclick="saveSettings()" class="bg-blue-600 text-white px-4 py-2 mt-4 rounded">
        บันทึกการตั้งค่า
      </button>
    </div>

  </div>

  <!-- Firebase -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import { ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    /* ------------------- โหลดค่าปัจจุบันของ Settings ------------------- */
    async function loadSettings() {
      const settingsRef = ref(db, "settings");
      const snapshot = await get(settingsRef);

      if (snapshot.exists()) {
        const data = snapshot.val();

        document.getElementById("minTemp").value = data.minTemp ?? "";
        document.getElementById("maxTemp").value = data.maxTemp ?? "";
        document.getElementById("phones").value = data.phones ? data.phones.join(",") : "";
      }
    }
    loadSettings();

    /* ------------------- ฟังก์ชันบันทึกค่าการตั้งค่า ------------------- */
    async function saveSettings() {
      const minTemp = parseFloat(document.getElementById("minTemp").value);
      const maxTemp = parseFloat(document.getElementById("maxTemp").value);
      const phones = document.getElementById("phones").value
        .split(",")
        .map(p => p.trim())
        .filter(p => p !== "");

      if (isNaN(minTemp) || isNaN(maxTemp)) {
        alert("กรุณากรอกค่าอุณหภูมิให้ถูกต้อง");
        return;
      }

      const settingsRef = ref(db, "settings");

      await set(settingsRef, {
        minTemp: minTemp,
        maxTemp: maxTemp,
        phones: phones
      });

      alert("อัปเดตการตั้งค่าเรียบร้อยแล้ว!");
    }

    /* ------------------- โหลดค่าจากเซ็นเซอร์แบบ Real-time ------------------- */
    const gpsRef = ref(db, "gps");

    onValue(gpsRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();

        document.getElementById("temp").textContent = data.temperature ?? "--";
        document.getElementById("hum").textContent = data.humidity ?? "--";
        document.getElementById("time").textContent = data.timestamp ?? "--";
      }
    });
  </script>

</body>
</html>
