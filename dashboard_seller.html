<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Cool Guard | Seller Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
:root{
  --primary:#f39c12;
  --bg:#f4f6f9;
  --card:#ffffff;
  --border:#e1e7ef;
  --text:#2c3e50;
  --muted:#7f8c8d;
  --success:#27ae60;
  --warning:#3498db;
  --danger:#e74c3c;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  background:linear-gradient(135deg,#f39c12,#d68910);
  color:#fff;
  padding:18px 28px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  border:none;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}

.logout{background:#fff;color:#f39c12}

.container{
  max-width:1280px;
  margin:auto;
  padding:28px;
}

/* Section */
.section{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:24px;
  margin-bottom:28px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

.section-title{
  font-size:18px;
  font-weight:800;
  color:#c97c0c;
  margin-bottom:16px;
}

/* Settings */
.setting-row{
  display:flex;
  gap:16px;
  align-items:center;
  flex-wrap:wrap;
}

.setting-row input{
  padding:10px;
  width:120px;
  border-radius:8px;
  border:1px solid var(--border);
}

.setting-row button{
  background:var(--primary);
  color:#fff;
}

/* Cards */
.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:22px;
}

.card{
  background:#fffaf2;
  border:1px solid var(--border);
  border-radius:18px;
  padding:26px;
  text-align:center;
}

.card-title{color:var(--muted)}
.card-value{font-size:36px;font-weight:800}

/* Status */
.status-high{color:var(--danger)}
.status-low{color:var(--warning)}
.status-normal{color:var(--success)}

/* Map */
#map{
  height:340px;
  border-radius:16px;
  border:1px solid var(--border);
  position:relative;
}
#gpsLost{
  position:absolute;
  top:14px;
  right:14px;
  background:var(--danger);
  color:#fff;
  padding:8px 14px;
  border-radius:10px;
  display:none;
}

/* Table */
table{width:100%;border-collapse:collapse}
th,td{
  padding:14px;
  border-bottom:1px solid #eee;
  text-align:center;
}
th{background:#f8f9fb}
tr:hover td{background:#fffdf7}

.pagination{
  margin-top:18px;
  display:flex;
  justify-content:center;
  gap:14px;
}
.pagination button{
  background:var(--primary);
  color:#fff;
}
</style>
</head>

<body>

<header>
  <b>Smart Cool Guard – Seller Dashboard</b>
  <button class="logout" onclick="logout()">Logout</button>
</header>

<div class="container">

<!-- SETTINGS -->
<div class="section">
  <div class="section-title">Temperature Alert Settings</div>
  <div class="setting-row">
    <label>Min (°C)</label>
    <input type="number" id="minTemp">
    <label>Max (°C)</label>
    <input type="number" id="maxTemp">
    <button onclick="saveSetting()">Save</button>
    <span id="saveMsg"></span>
  </div>
</div>

<!-- SUMMARY -->
<div class="section">
  <div class="section-title">Realtime Summary</div>
  <div class="cards">
    <div class="card">
      <div class="card-title">Temperature</div>
      <div class="card-value" id="cardTemp">-- °C</div>
    </div>
    <div class="card">
      <div class="card-title">Humidity</div>
      <div class="card-value" id="cardHum">-- %</div>
    </div>
    <div class="card">
      <div class="card-title">Status</div>
      <div class="card-value" id="cardStatus">--</div>
    </div>
  </div>
</div>

<!-- MAP -->
<div class="section">
  <div class="section-title">Current Location</div>
  <div id="map">
    <div id="gpsLost">GPS Not Found</div>
  </div>
</div>

<!-- TABLE -->
<div class="section">
  <div class="section-title">Temperature Records</div>
  <table>
    <thead>
      <tr>
        <th>Date / Time</th>
        <th>Temp</th>
        <th>Humidity</th>
        <th>GPS</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">Previous</button>
    <button onclick="nextPage()">Next</button>
  </div>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

/* Firebase */
initializeApp({
  apiKey:"AIzaSyBHCnAFJHBz95ugYztMkxBa5b6fwqCZqfo",
  databaseURL:"https://temperature-cold-guard-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase();

/* Auth */
if(localStorage.getItem("role")!=="Seller") location.href="login.html";

/* Temp Setting */
let TEMP_MIN=0, TEMP_MAX=0;
onValue(ref(db,"settings/temperature"),s=>{
  const d=s.val();
  if(d){
    TEMP_MIN=d.min;
    TEMP_MAX=d.max;
    minTemp.value=d.min;
    maxTemp.value=d.max;
  }
});

/* Save setting */
window.saveSetting=()=>{
  set(ref(db,"settings/temperature"),{
    min:Number(minTemp.value),
    max:Number(maxTemp.value)
  });
  saveMsg.textContent="✔ Saved";
  setTimeout(()=>saveMsg.textContent="",2000);
};

/* Status */
function getStatus(t){
  if(t>TEMP_MAX) return {text:"High Temperature",cls:"status-high"};
  if(t<TEMP_MIN) return {text:"Low Temperature",cls:"status-low"};
  return {text:"Normal",cls:"status-normal"};
}

/* Map */
let map,marker;
function initMap(){
  if(map) return;
  map=L.map("map").setView([13.7,100.5],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* Data */
let records=[],page=0,pageSize=10;
onValue(ref(db,"records"),s=>{
  records=Object.entries(s.val()||{}).reverse();
  if(records[0]) updateSummary(records[0][1]);
  render();
});

function updateSummary(r){
  cardTemp.textContent=r.temperature+" °C";
  cardHum.textContent=r.humidity+" %";

  const s=getStatus(Number(r.temperature));
  cardStatus.textContent=s.text;
  cardStatus.className="card-value "+s.cls;

  initMap();
  const lat=Number(r?.gps?.lat);
  const lng=Number(r?.gps?.lng);

  if(!lat||!lng){
    gpsLost.style.display="block";
    return;
  }

  gpsLost.style.display="none";
  if(!marker) marker=L.marker([lat,lng]).addTo(map);
  else marker.setLatLng([lat,lng]);
  map.setView([lat,lng],13);
}

function render(){
  tableBody.innerHTML="";
  records.slice(page*pageSize,(page+1)*pageSize).forEach(([k,r])=>{
    const gps=(!r.gps||!r.gps.lat||!r.gps.lng)?"Not found":`${r.gps.lat}, ${r.gps.lng}`;
    const s=getStatus(Number(r.temperature));
    tableBody.innerHTML+=`
      <tr>
        <td>${k}</td>
        <td>${r.temperature}</td>
        <td>${r.humidity}</td>
        <td>${gps}</td>
        <td class="${s.cls}">${s.text}</td>
      </tr>`;
  });
}

window.nextPage=()=>{page++;render();}
window.prevPage=()=>{if(page>0)page--;render();}
window.logout=()=>{localStorage.clear();location.href="login.html";}
</script>

</body>
</html>
