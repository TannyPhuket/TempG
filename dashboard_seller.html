<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä Seller Dashboard | Smart Cold Guard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 300px; border-radius: 1rem; }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-100 via-white to-blue-50 min-h-screen font-sans">
  <!-- Header -->
  <nav class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-semibold">‚ùÑÔ∏è Smart Cold Guard ‚Äì Seller</h1>
    <button onclick="window.location.href='index.html'" class="bg-blue-800 hover:bg-blue-900 px-4 py-2 rounded-lg">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </nav>

  <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Real-time Info -->
    <div class="bg-white rounded-2xl p-6 shadow">
      <h2 class="text-lg font-bold text-blue-600 mb-3">üå°Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h2>
      <p>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <span id="temp" class="font-semibold">--</span></p>
      <p>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô: <span id="hum" class="font-semibold">--</span></p>
      <p>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="gps" class="font-semibold">--</span></p>

      <div class="mt-4 border-t pt-4">
        <h3 class="font-semibold mb-2">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</h3>
        <div class="flex gap-2">
          <input id="minTemp" type="number" class="border rounded px-3 py-2 w-full" placeholder="Min ¬∞C">
          <input id="maxTemp" type="number" class="border rounded px-3 py-2 w-full" placeholder="Max ¬∞C">
        </div>
        <button onclick="saveSettings()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <p id="saveMsg" class="text-green-600 mt-2 hidden">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
      </div>
    </div>

    <!-- Map -->
    <div id="map" class="rounded-2xl shadow h-80"></div>
  </div>

  <!-- Chart -->
  <div class="bg-white rounded-2xl shadow m-6 p-6">
    <h2 class="text-lg font-bold text-blue-600 mb-4">üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h2>
    <canvas id="tempChart" height="100"></canvas>

    <div id="pagination" class="flex justify-center space-x-2 mt-4"></div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, set, query, orderByKey, limitToLast } 
      from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // Elements
    const tempEl = document.getElementById("temp");
    const humEl = document.getElementById("hum");
    const gpsEl = document.getElementById("gps");
    const saveMsg = document.getElementById("saveMsg");
    const minTempEl = document.getElementById("minTemp");
    const maxTempEl = document.getElementById("maxTemp");

    // Realtime refs
    const tempRef = ref(db, "Data/Temperature");
    const humRef = ref(db, "Data/Humidity");
    const gpsRef = ref(db, "Data/GPS");
    const settingsRef = ref(db, "settings");

    // Update realtime values
    onValue(tempRef, snap => tempEl.textContent = snap.val()?.toFixed(2) ?? "--");
    onValue(humRef, snap => humEl.textContent = snap.val()?.toFixed(2) ?? "--");
    let map, marker;
    onValue(gpsRef, snap => {
      const gps = snap.val();
      const lat = gps?.lat ?? 14.12345;
      const lng = gps?.lng ?? 100.98765;
      gpsEl.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      if (!map) {
        map = L.map("map").setView([lat, lng], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap"
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map).bindPopup("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå").openPopup();
      } else {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng]);
      }
    });

    // Load settings
    onValue(settingsRef, snap => {
      const data = snap.val();
      minTempEl.value = data?.minTemp ?? "";
      maxTempEl.value = data?.maxTemp ?? "";
    });

    // Save settings
    window.saveSettings = async () => {
      const min = parseFloat(minTempEl.value);
      const max = parseFloat(maxTempEl.value);
      if (isNaN(min) || isNaN(max)) return;
      await set(settingsRef, { minTemp: min, maxTemp: max });
      saveMsg.classList.remove("hidden");
      setTimeout(() => saveMsg.classList.add("hidden"), 2000);
    };

    // Chart setup
    const ctx = document.getElementById("tempChart").getContext("2d");
    const tempChart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label: "‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)", data: [], borderColor: "#3B82F6", backgroundColor: "#BFDBFE", fill: true }] },
      options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });

    // Load history (last 30 days)
    function loadHistory() {
      const now = Date.now();
      const monthAgo = now - 30*24*60*60*1000;
      const q = query(ref(db, "History"), orderByKey(), limitToLast(1500));
      onValue(q, snap => {
        const all = snap.val();
        if (!all) return;
        const filtered = Object.entries(all)
          .filter(([ts]) => parseInt(ts) >= monthAgo)
          .map(([ts, val]) => ({ date: new Date(parseInt(ts)).toLocaleString("th-TH",{hour12:false}), temp: val.Temperature }));
        renderChartPage(filtered,1);
        renderPagination(filtered);
      });
    }

    const perPage = 15;
    function renderChartPage(data,page){
      const start=(page-1)*perPage;
      const sliced=data.slice(start,start+perPage);
      tempChart.data.labels=sliced.map(d=>d.date);
      tempChart.data.datasets[0].data=sliced.map(d=>d.temp);
      tempChart.update();
    }

    function renderPagination(data){
      const container=document.getElementById("pagination");
      container.innerHTML="";
      const totalPages=Math.ceil(data.length/perPage);
      for(let i=1;i<=totalPages;i++){
        const btn=document.createElement("button");
        btn.textContent=i;
        btn.className=`px-3 py-1 rounded-lg ${i===1?"bg-blue-600 text-white":"bg-gray-200 hover:bg-blue-100"}`;
        btn.onclick=()=>renderChartPage(data,i);
        container.appendChild(btn);
      }
    }

    window.onload = loadHistory;
  </script>
</body>
</html>
