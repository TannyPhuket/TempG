<script type="module">
import { db } from "./js/firebase-config.js";
import { ref, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

async function loginUser() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const msg = document.getElementById("msg");

  if (!email || !password) {
    msg.textContent = "⚠️ กรุณากรอกข้อมูลให้ครบถ้วน";
    msg.classList.remove("hidden");
    return;
  }

  try {
    // แปลง Email ให้เป็น key ที่ปลอดภัย
    const key = email.toLowerCase().replace(/[.#$[\]]/g, "_");
    const userRef = ref(db, "users/" + key);
    const snap = await get(userRef);

    if (!snap.exists()) {
      msg.textContent = "❌ ไม่พบผู้ใช้นี้";
      msg.classList.remove("hidden");
      return;
    }

    const data = snap.val();

    // ตรวจสอบ Password
    if (data.password !== password) {
      msg.textContent = "❌ Password ไม่ถูกต้อง";
      msg.classList.remove("hidden");
      return;
    }

    // ตรวจ Role
    const role = data.Role;
    if (role === "Buyer") {
      window.location.href = "dashboard_buyer.html";
    } else if (role === "Seller") {
      window.location.href = "dashboard_seller.html";
    } else if (role === "Driver") {
      window.location.href = "dashboard_driver.html";
    } else {
      msg.textContent = "❌ Role ไม่ถูกต้อง";
      msg.classList.remove("hidden");
    }

  } catch (err) {
    msg.textContent = "⚠️ ไม่สามารถเชื่อมต่อ Firebase";
    msg.classList.remove("hidden");
    console.error(err);
  }
}

window.loginUser = loginUser;
</script>
