<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-sky-50 to-blue-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">üöö Driver Dashboard</h1>
      <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
    </div>

    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- ¬∞C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h3>
      <canvas id="chartDriver" height="120"></canvas>

      <div class="mt-3 text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô</div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart
    const ctx = document.getElementById('chartDriver').getContext('2d');
    const chartDriver = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' ¬∞C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // load history up to 7 days (and limit to reasonable number)
    function loadHistory(days=7){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(1000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ chartDriver.data.labels=[]; chartDriver.data.datasets[0].data=[]; chartDriver.update(); return; }
        const arr = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> a.ts - b.ts); // old -> new
        chartDriver.data.labels = arr.map(it=> new Date(it.ts).toLocaleString());
        chartDriver.data.datasets[0].data = arr.map(it=> it.temp);
        chartDriver.update();
      });
    }

    loadHistory(7);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }
  </script>
</body>
</html>
