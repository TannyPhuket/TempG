<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buyer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-700">❄️ Buyer Dashboard</h1>
      <div>
        <button onclick="logout()" class="px-3 py-2 bg-gray-100 rounded">Logout</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Temperature</div>
        <div id="curTemp" class="text-3xl font-bold text-blue-700">-- °C</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">Humidity</div>
        <div id="curHum" class="text-3xl font-bold text-blue-700">-- %</div>
      </div>
      <div class="p-4 bg-blue-50 rounded shadow">
        <div class="text-sm text-gray-500">GPS</div>
        <div id="curGps" class="text-lg font-medium text-blue-700">--</div>
      </div>
    </div>

    <div id="map" class="h-64 rounded mb-6"></div>

    <div class="bg-white rounded p-4 shadow mb-6">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-semibold">กราฟอุณหภูมิ (ย้อนหลัง)</h3>
        <div class="flex items-center gap-2">
          <label class="text-sm">View</label>
          <select id="viewMode" class="border rounded p-1" onchange="onViewModeChange()">
            <option value="daily">รายวัน</option>
            <option value="weekly">รายสัปดาห์</option>
            <option value="monthly">รายเดือน</option>
          </select>
        </div>
      </div>
      <canvas id="chartBuyer" height="140"></canvas>
    </div>

    <div class="bg-white rounded p-4 shadow">
      <h3 class="font-semibold mb-3">ประวัติย้อนหลัง (30 วัน)</h3>
      <table class="w-full text-left">
        <thead class="text-sm text-gray-500"><tr><th class="p-2">เวลา</th><th class="p-2">Temp (°C)</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>

      <div class="flex justify-between items-center mt-3">
        <div id="pageInfo" class="text-sm text-gray-600">หน้า 1</div>
        <div>
          <button onclick="prevPage()" class="px-3 py-1 bg-gray-100 rounded mr-2">ก่อนหน้า</button>
          <button onclick="nextPage()" class="px-3 py-1 bg-gray-100 rounded">ถัดไป</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { ref, onValue, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // map
    let map = L.map('map').setView([14.12345,100.98765],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker = L.marker([14.12345,100.98765]).addTo(map);

    const curTemp = document.getElementById('curTemp');
    const curHum = document.getElementById('curHum');
    const curGps = document.getElementById('curGps');

    // chart buyer
    const ctx = document.getElementById('chartBuyer').getContext('2d');
    const buyerChart = new Chart(ctx, { type:'line', data:{ labels:[], datasets:[{label:'Temp', data:[], borderColor:'#2563EB', fill:true, backgroundColor:'rgba(37,99,235,0.08)'}] }, options:{responsive:true} });

    // realtime data
    onValue(ref(db,'Data'), snap=>{
      if (!snap.exists()) return;
      const d = snap.val();
      curTemp.textContent = (d.Temperature ?? '--') + ' °C';
      curHum.textContent = (d.Humidity ?? '--') + ' %';
      if (d.GPS && d.GPS.lat && d.GPS.lng) {
        curGps.textContent = `${d.GPS.lat.toFixed(5)}, ${d.GPS.lng.toFixed(5)}`;
        marker.setLatLng([d.GPS.lat, d.GPS.lng]); map.setView([d.GPS.lat, d.GPS.lng]);
      }
    });

    // history & pagination logic (30 days)
    let historyData = [];
    const perPage = 10;
    let currentPage = 1;
    let viewMode = 'daily';

    function loadHistory(days=30){
      const now = Date.now();
      const limit = now - days*24*60*60*1000;
      const q = query(ref(db,'History'), orderByKey(), limitToLast(2000));
      onValue(q, snap=>{
        const all = snap.val(); if(!all){ historyData=[]; renderHistory(); buyerChart.update(); return; }
        historyData = Object.entries(all)
          .map(([k,v])=>({ts: parseInt(k), temp: v.Temperature}))
          .filter(it=> it.ts >= limit)
          .sort((a,b)=> b.ts - a.ts);
        currentPage = 1;
        renderHistory();
        renderChart();
      });
    }

    function renderHistory(){
      const tbody = document.getElementById('historyBody'); tbody.innerHTML='';
      const start = (currentPage-1)*perPage;
      const slice = historyData.slice(start,start+perPage);
      slice.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 text-sm">${new Date(r.ts).toLocaleString()}</td><td class="p-2 text-sm">${r.temp.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('pageInfo').textContent = `หน้า ${currentPage} / ${Math.max(1, Math.ceil(historyData.length/perPage))}`;
    }

    function prevPage(){ if(currentPage>1){ currentPage--; renderHistory(); } }
    function nextPage(){ if(currentPage * perPage < historyData.length){ currentPage++; renderHistory(); } }

    // chart modes (daily/weekly/monthly)
    function renderChart(){
      if (!historyData.length){ buyerChart.data.labels=[]; buyerChart.data.datasets[0].data=[]; buyerChart.update(); return; }
      if (viewMode === 'daily'){
        const pts = historyData.slice().reverse();
        buyerChart.data.labels = pts.map(p=> new Date(p.ts).toLocaleString());
        buyerChart.data.datasets[0].data = pts.map(p=> p.temp);
      } else if (viewMode === 'weekly'){
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const onejan = new Date(d.getFullYear(),0,1);
          const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
          const key = `${d.getFullYear()}-W${week}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      } else {
        const groups = {};
        historyData.forEach(it=>{
          const d = new Date(it.ts);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          groups[key] = groups[key] || { sum:0, cnt:0 };
          groups[key].sum += it.temp; groups[key].cnt++;
        });
        const keys = Object.keys(groups).sort();
        buyerChart.data.labels = keys;
        buyerChart.data.datasets[0].data = keys.map(k=> (groups[k].sum/groups[k].cnt).toFixed(2));
      }
      buyerChart.update();
    }

    function onViewModeChange(){ viewMode = document.getElementById('viewMode').value; renderChart(); }

    loadHistory(30);

    function logout(){ sessionStorage.removeItem('cg_role'); sessionStorage.removeItem('cg_user'); window.location.href='index.html'; }

    // Expose for buttons
    window.prevPage = prevPage;
    window.nextPage = nextPage;
    window.onViewModeChange = onViewModeChange;
    window.logout = logout;
  </script>
</body>
</html>
